<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ­£åœ¨å¤„ç† - äº¤å‰æ£€éªŒç³»ç»Ÿ</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f4f7f6; text-align: center; padding: 40px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        #log-container { 
            margin-top: 20px; padding: 20px; background: #2c3e50; color: #ecf0f1; 
            border-radius: 8px; font-family: 'Courier New', monospace; text-align: left; 
            height: 400px; overflow-y: auto; white-space: pre-wrap; 
        }
        .spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #result-link { display: none; margin-top: 20px; padding: 12px 25px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ™ºèƒ½å®¡æŸ¥æ­£åœ¨è¿›è¡Œä¸­...</h1>
        <p>è¯·ä¸è¦å…³é—­æ­¤é¡µé¢ï¼Œç³»ç»Ÿæ­£åœ¨åå°å¤„ç†æ‚¨çš„æ–‡ä»¶ã€‚</p>
        <div id="spinner" class="spinner"></div>
        <div id="log-container"></div>
        <a id="result-link" href="#">ğŸ‰ åˆ†æå®Œæˆï¼Œç‚¹å‡»æŸ¥çœ‹æŠ¥å‘Š</a>
    </div>

    <script>
        const taskId = "{{ task_id }}";
        const logContainer = document.getElementById('log-container');
        const resultLink = document.getElementById('result-link');
        const spinner = document.getElementById('spinner');
        let logLength = 0;

        function pollStatus() {
            fetch(`/api/status/${taskId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // æ£€æŸ¥æ•°æ®çš„æœ‰æ•ˆæ€§
                    if (!data) {
                        throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                    }
                    
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    console.log('æ”¶åˆ°APIå“åº”:', {
                        status: data.status,
                        logLength: (data.log || []).length,
                        hasError: !!data.error
                    });
                    
                    // ç¡®ä¿ log å­˜åœ¨ä¸”æ˜¯æ•°ç»„
                    const logArray = data.log || [];
                    
                    // Append new log messages
                    if (logArray.length > logLength) {
                        const newMessages = logArray.slice(logLength).join('\n');
                        logContainer.textContent += newMessages + '\n';
                        logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll
                        logLength = logArray.length;
                    }

                    if (data.status === 'complete') {
                        console.log('ğŸ‰ ä»»åŠ¡å®Œæˆï¼Œæ˜¾ç¤ºæŒ‰é’®');
                        spinner.style.display = 'none';
                        resultLink.href = `/result/${taskId}`;
                        resultLink.style.display = 'inline-block';
                        console.log('æŒ‰é’®å·²è®¾ç½®ä¸ºæ˜¾ç¤ºï¼š', resultLink.style.display);
                        clearInterval(intervalId);
                    } else if (data.status === 'error') {
                        spinner.style.display = 'none';
                        logContainer.textContent += '\nâŒ ä»»åŠ¡å¤„ç†å¤±è´¥ï¼Œè¯·è¿”å›é¦–é¡µé‡è¯•ã€‚';
                        clearInterval(intervalId);
                    } else if (data.status === 'not_found') {
                        spinner.style.display = 'none';
                        logContainer.textContent += '\nâŒ ä»»åŠ¡æœªæ‰¾åˆ°ï¼Œè¯·è¿”å›é¦–é¡µé‡æ–°å¼€å§‹ã€‚';
                        clearInterval(intervalId);
                    }
                })
                .catch(err => {
                    console.error('è½®è¯¢çŠ¶æ€é”™è¯¯:', err);
                    logContainer.textContent += '\nâŒ æŸ¥è¯¢è¿›åº¦å¤±è´¥: ' + err.message;
                    
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œç»§ç»­é‡è¯•
                    if (err.message.includes('fetch') || err.message.includes('network')) {
                        logContainer.textContent += '\nğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œ10ç§’åé‡è¯•...';
                        // ä¸æ¸…é™¤å®šæ—¶å™¨ï¼Œç»§ç»­é‡è¯•
                    } else {
                        // å…¶ä»–é”™è¯¯åœæ­¢è½®è¯¢
                        clearInterval(intervalId);
                    }
                });
        }

        const intervalId = setInterval(pollStatus, 2000); // Poll every 2 seconds
        pollStatus(); // Initial call
    </script>
</body>
</html>
